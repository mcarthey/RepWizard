name: CI

on:
  push:
    branches: ["main", "claude/**", "feature/**", "fix/**"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: "9.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Job 1: Build and test the non-MAUI projects using a solution filter.
  #         Runs on every push/PR. Includes smoke test for DI verification.
  # ─────────────────────────────────────────────────────────────────────────────
  build-and-test:
    name: Build & Test (.NET 9)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/global.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore (non-MAUI via solution filter)
        run: dotnet restore RepWizard.CI.slnf

      - name: Build
        run: dotnet build RepWizard.CI.slnf --no-restore -c Release

      - name: Test with coverage
        run: |
          dotnet test RepWizard.CI.slnf \
            --no-build -c Release \
            --settings ./coverage.runsettings \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=normal" \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: Smoke test API startup
        run: |
          cd RepWizard.Api
          ASPNETCORE_ENVIRONMENT=Development \
          ASPNETCORE_URLS="http://localhost:5099" \
          Jwt__Secret="CI-Smoke-Test-JWT-Key-Must-Be-At-Least-32-Bytes!" \
          dotnet run --no-build -c Release &
          API_PID=$!

          # Wait for API to start (max 30 seconds)
          for i in $(seq 1 30); do
            if curl -s http://localhost:5099/health > /dev/null 2>&1; then
              echo "API started after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "API failed to start within 30s"
              kill $API_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          # Verify health endpoint
          RESPONSE=$(curl -s -f http://localhost:5099/health)
          echo "Health response: $RESPONSE"

          # Verify auth gate returns 401 (not 500) on protected endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            http://localhost:5099/api/v1/users/00000000-0000-0000-0000-000000000000)
          if [ "$HTTP_CODE" = "401" ]; then
            echo "Auth gate working (401 on protected endpoint)"
          else
            echo "Unexpected status $HTTP_CODE on protected endpoint (expected 401)"
            kill $API_PID 2>/dev/null || true
            exit 1
          fi

          kill $API_PID 2>/dev/null || true
          echo "Smoke test passed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults/
          retention-days: 14

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: TestResults/**/coverage.cobertura.xml
          retention-days: 14

  # ─────────────────────────────────────────────────────────────────────────────
  # Job 2: Verify the MAUI projects compile (UI + App) with the full workload.
  #         Uses a macOS runner which has MAUI workloads available.
  #         Only runs on PRs to main and pushes to main to keep costs down.
  # ─────────────────────────────────────────────────────────────────────────────
  build-maui:
    name: Build MAUI (compile check)
    runs-on: macos-15
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install MAUI workloads
        run: dotnet workload install maui

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-maui-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/global.json') }}
          restore-keys: |
            nuget-maui-${{ runner.os }}-

      - name: Restore MAUI projects
        run: |
          dotnet restore RepWizard.UI/RepWizard.UI.csproj
          dotnet restore RepWizard.App/RepWizard.App.csproj

      # Build for a single RID to keep the job fast (Android release is the
      # canonical compile check; iOS would require signing certificates)
      - name: Build MAUI (Android)
        run: |
          dotnet build RepWizard.UI/RepWizard.UI.csproj \
            --no-restore -c Release -f net9.0-android
          dotnet build RepWizard.App/RepWizard.App.csproj \
            --no-restore -c Release -f net9.0-android

  # ─────────────────────────────────────────────────────────────────────────────
  # Job 3: Publish a summary comment on PRs with test / coverage results.
  # ─────────────────────────────────────────────────────────────────────────────
  pr-summary:
    name: PR test summary
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      checks: write

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: TestResults

      - name: Publish test summary
        uses: dorny/test-reporter@v1
        with:
          name: xUnit test results
          path: "TestResults/**/*.trx"
          reporter: dotnet-trx
          fail-on-error: true
